name: Maven Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Version att slÃ¤ppa (t.ex. 1.0.4)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Klona repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # KrÃ¤vs fÃ¶r att kunna pusha taggar

      - name: SÃ¤tt upp Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '18'

      - name: Git anvÃ¤ndarinfo
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: SÃ¤tt release-version i pom.xml
        run: |
          mvn versions:set -DnewVersion=${{ github.event.inputs.release_version }} -DgenerateBackupPoms=false

      - name: Commit release-version
        run: |
          git commit -am "ðŸ”– Release version ${{ github.event.inputs.release_version }}"
          git push origin develop

      - name: Skapa tagg
        run: |
          git tag -a v${{ github.event.inputs.release_version }} -m "Release version ${{ github.event.inputs.release_version }}"
          git push origin v${{ github.event.inputs.release_version }}

      - name: Merga develop â†’ main
        run: |
          git fetch origin
          git checkout main
          git merge origin/develop --no-ff -m "ðŸš€ Merge release ${{ github.event.inputs.release_version }} to main"
          git push origin main

      - name: GÃ¥ tillbaka till develop och bump version
        run: |
          git checkout develop
          IFS='.' read -r MAJOR MINOR PATCH <<< "${{ github.event.inputs.release_version }}"
          NEXT_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))-SNAPSHOT"
          mvn versions:set -DnewVersion=$NEXT_VERSION -DgenerateBackupPoms=false
          git commit -am "ðŸ”§ Start next development iteration: $NEXT_VERSION"
          git push origin develop
